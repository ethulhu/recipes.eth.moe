<html>
<head>
  <title>brandy butter</title>
  <script src='./elems.js'></script>
  <script src='./menu.js'></script>
  <script src='./recipe.js'></script>
<style>
ul.doable {
  list-style: none;
}
.done {
  text-decoration: line-through;
}
</style>
</head>

<body>
  <main>
  </main>

<script>
'use strict';

// Setup.

Elems.register( {
    toObject: window,
    withNameFunc: n => '_' + n,
  },
  'nav', 'a', 'h1', 'li', 'h2', 'section', 'label', 'input', 'ul', 'span');

function handleEvent( querySelector, event, handlerFunc ) {
  window.addEventListener( event, e => {
    if ( e.target.matches( querySelector ) ) {
      handlerFunc( e );
    }
  } );
}

// DoableSection.

function newDoableItem( text ) {
  return _li(
           _label(
             _input( { type: 'checkbox', class: 'doable' } ),
             _span( text ),
           )
         );
}
function newDoableSection( title, items ) {
  return _section(
           _h2( title ),
           _ul( { class: 'doable' },
             items.map( newDoableItem ),
           ),
         );
}
handleEvent( 'input.doable', 'change', e => e.target
                                             .parentElement
                                             .classList
                                             .toggle( 'done' ) );

// Page render-funcs.

function renderMenu( text ) {
  let menu = Menu.parse( text );

  let render = Elems.renderFuncForSelector( 'main' );
  render(
    _h1( 'recipes' ),
    _nav(
      menu.items.map(
        item => _li(
                  _a(
                    item.name,
                    { href: '#' + item.path },
                  )
                )
      )
    )
  );
}

function renderRecipe( text ) {
  let recipe = Recipe.parse( text );

  let render = Elems.renderFuncForSelector( 'main' );
  render(
    _h1( recipe.name ),
    ['needs', 'steps'].map( key =>
      newDoableSection( key, recipe[ key ] )
    ),
  );
}

// Loaders.

function load( path, renderFunc ) {
  fetch( path ).then( response => {
    if ( response.status !== 200 ) {
      console.log( 'failed to fetch ' + path );
      return;
    }

    response.text().then( renderFunc );
  } );
}

function renderPage() {
  if ( ! window.location.hash ) {
    load( './recipes.lst', renderMenu );
  } else {
    let name = window.location.hash.slice( 1 );
    load( './' + name + '.rcp', renderRecipe );
  }
}
window.addEventListener( 'popstate', renderPage ); // Refresh on history or URL change.
renderPage();

</script>
</body>
</html>
