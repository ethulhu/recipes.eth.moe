<html>
<head>
  <meta charset='utf-8'>
  <title>recipes</title>
  <script src='./elems.js'></script>
  <script src='./menu.js'></script>
  <script src='./recipe.js'></script>
  <style>
    ul.doable {
      list-style: none;
    }
    .done {
      text-decoration: line-through;
    }
  </style>
</head>

<body>
  <main>
  </main>

<script>
'use strict';

// Setup.

Elems.register( {
    toObject: window,
    withNameFunc: n => '_' + n,
  },
  'nav', 'a', 'h1', 'li', 'h2', 'section', 'label', 'input', 'ul', 'span');

function handleEvent( querySelector, event, handlerFunc ) {
  window.addEventListener( event, e => {
    if ( e.target.matches( querySelector ) ) {
      handlerFunc( e );
    }
  } );
}

// Page render-funcs.

function renderMenu( text ) {
  const menu = Menu.parse( text );

  document.title = 'recipes';

  const render = Elems.renderFuncForSelector( 'main' );
  render(
    _h1( 'recipes' ),
    _nav(
      menu.items.map(
        item => _li(
                  _a(
                    item.name,
                    { href: '#' + item.path },
                  )
                )
      )
    )
  );
}

Storage.prototype.putObject =
  ( k, v ) => localStorage.setItem( k, JSON.stringify( v ) );

Storage.prototype.getObject =
  k => JSON.parse( localStorage.getItem( k ) || 'null' );

// object = {
//   lastRead: epochTime,
//   needs: { string, bool },
//   steps: { string, bool },
// }
function modifyState( recipeName, modifyFunc ) {
  const path = 'recipes:' + recipeName;
  let state = localStorage.getObject( path ) ||
              { lastRead: Date.now(), needs: {}, steps: {} };
  modifyFunc( state );
  state.lastRead = Date.now();
  localStorage.putObject( path, state );
  return state;
}
function setDoable( recipe, section, doable, done ) {
  modifyState( recipe, state => {
    state[ section ][ doable ] = done;
  } );
}

function renderRecipe( text ) {
  const recipe = Recipe.parse( text );
  const state = modifyState( recipe.name, s => s );

  document.title = 'recipes - ' + recipe.name;

  const render = Elems.renderFuncForSelector( 'main' );

  const newDoableSection =
    ( title, items ) =>
      _section(
        _h2( title ),
        _ul(
          { class: 'doable' },
          items.map( text =>
            _li(
              _label(
                { class:
                    state[ title ][ text ] ?  'done' : '' },
                _input(
                  { type: 'checkbox' },
                  { class: 'doable' },
                  { checked:
                      state[ title ][ text ] ? true : null },
                  { recipe: recipe.name },
                  { section: title },
                  { doable: text },
                ),
                _span( text ),
              )
            )
          ),
        ),
      );

  render(
    _a ( { href: '#' }, '>back' ),
    _h1( recipe.name ),
    ['needs', 'steps'].map( key =>
      newDoableSection( key, recipe[ key ] )
    ),
  );
}
handleEvent( 'input.doable', 'change', e => {
  e.target.parentElement.classList.toggle( 'done' );

  setDoable(
    e.target.getAttribute( 'recipe' ),
    e.target.getAttribute( 'section' ),
    e.target.getAttribute( 'doable' ),
    e.target.parentElement.classList.contains( 'done' )
  );
} );

// Loaders.

function load( path, renderFunc ) {
  fetch( path ).then( response => {
    if ( response.status !== 200 ) {
      console.log( 'failed to fetch ' + path );
      return;
    }

    response.text().then( renderFunc );
  } );
}

function renderPage() {
  if ( ! window.location.hash ) {
    load( './recipes.list', renderMenu );
  } else {
    const name = window.location.hash.slice( 1 );
    load( './recipes/' + name, renderRecipe );
  }
}
window.addEventListener( 'popstate', renderPage ); // Refresh on history or URL change.
renderPage();

</script>
</body>
</html>
